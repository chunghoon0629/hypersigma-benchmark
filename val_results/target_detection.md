# Target Detection (타겟 탐지) - AVIRIS 데이터셋

## 1차 검증: 논문 기반

### 논문 요약

HyperSIGMA 논문에서 Target Detection 태스크는 **Test-time Adaptation** 방식으로 진행된다.
테스트 이미지 자체에서 Pseudo-label을 생성하여 모델을 적응시킨 후 평가한다.

#### Pseudo-label 생성 (Coarse Detection)
- **알고리즘**: CEM (Constrained Energy Minimization)
- **타겟 라벨링**: 상위 **1.5%** 픽셀
- **배경 라벨링**: 하위 **30%** 픽셀
- **나머지**: 손실 계산 시 무시

#### 입력 구성
- **패치 크기**: 32×32
- **패치 중복**: 16 픽셀

#### 학습 설정
| 항목 | 값 |
|------|-----|
| 에포크 | 10 |
| 배치 사이즈 | 2 |
| 학습률 | 6e-5 |
| 옵티마이저 | AdamW |
| 스펙트럼 토큰 수 | 100 |
| 손실 함수 | Cross-Entropy |

#### 인코더 설정
- 패치 임베딩 레이어: 무작위 초기화 후 재학습
- 전체 네트워크 미세 조정


---

## 2차 검증: 원저자 코드 기반

**원저자 코드 경로**: `~/gsjo/paper/HyperSIGMA/HyperspectralDetection/Target_Detection/`

### 중요 발견: 논문 vs 원저자 코드 차이

| 항목 | 논문 | 원저자 코드 |
|------|------|-------------|
| 타겟 라벨링 | 상위 1.5% | 상위 **0.15%** |

### 원저자 코드 분석 결과

#### Pseudo-label 생성
| 항목 | 원저자 코드 | 비고 |
|------|-------------|------|
| 알고리즘 | RX/CEM 기반 탐지 맵 | 사전 계산된 coarse_det 사용 |
| 타겟 라벨링 | 상위 0.15% | `all_idxs[-int(0.0015*r*c):]` |
| 배경 라벨링 | 하위 30% | `all_idxs[:int(0.3*r*c)]` |
| 무시 라벨 | 255 | 나머지 69.85% 픽셀 |

#### 입력 설정
| 항목 | 원저자 코드 |
|------|-------------|
| 패치 크기 | 32×32 |
| 패치 중복 | 16 |
| Step Size | 16 (= 32 - 16) |

#### 학습 설정
| 항목 | 원저자 코드 |
|------|-------------|
| 에포크 | 10 |
| 배치 사이즈 | 2 |
| 학습률 | 6e-5 |
| Weight Decay | 5e-4 |
| 옵티마이저 | AdamW (betas=0.9, 0.999) |
| Layer Decay Rate | 0.9 |
| Scheduler | CosineAnnealingLR (eta_min=0) |
| 손실 함수 | CrossEntropyLoss (ignore_index=255) |

#### 정규화 및 기타
| 항목 | 원저자 코드 |
|------|-------------|
| 입력 정규화 | StandardScaler |
| 출력 정규화 | Min-Max [0, 1] |
| Target Spectrum | 타겟 픽셀의 평균 스펙트럼 |


---

## 검증 결과 종합

### i) 논문에 있는데 다른 것 ❌

| 항목 | 논문 | 원저자 | 현재 구현 |
|------|------|--------|-----------|
| **Pseudo-label 생성** | CEM | RX/CEM | **미구현** ❌ |
| **타겟 라벨링** | 상위 1.5% | 상위 0.15% | **직접 라벨** ❌ |
| **배경 라벨링** | 하위 30% | 하위 30% | **1:5 샘플링** ❌ |
| **패치 크기** | 32×32 | 32×32 | **7×7** ❌ |
| **패치 중복** | 16 | 16 | **없음** ❌ |
| **에포크** | 10 | 10 | **50** ❌ |
| **배치 사이즈** | 2 | 2 | **32** ❌ |
| **학습률** | 6e-5 | 6e-5 | **1e-4** ❌ |
| **손실 함수** | CE | CE | **BCEWithLogitsLoss** ❌ |

### ii) 논문에 언급되지 않은 디테일 (원저자 코드로 확인)

| 항목 | 원저자 코드 | 현재 구현 | 일치 |
|------|-------------|-----------|------|
| Weight Decay | 5e-4 | 0.01 | ❌ |
| Layer Decay | 0.9 | 미적용 | ❌ |
| Scheduler eta_min | 0 | 1e-6 | ❌ |
| 정규화 | StandardScaler | Min-Max | ❌ |
| ignore_index | 255 | 없음 | ❌ |

### iii) 논문/원저자와 일치하는 것 ✅

| 항목 | 논문 | 원저자 | 현재 구현 | 일치 |
|------|------|--------|-----------|------|
| 스펙트럼 토큰 수 | 100 | 100 | 100 | ✅ |
| 옵티마이저 | AdamW | AdamW | AdamW | ✅ |


---

## 최종 결론

| 구분 | 개수 | 상태 |
|------|------|------|
| **논문/원저자 일치** | 2개 | ✅ |
| **논문/원저자 불일치** | 9개 | ❌ |
| **원저자 불일치 (미언급)** | 5개 | ❌ |

### 수정 필요 사항 (우선순위 순)

1. **Pseudo-label 생성 구현**
   - RX/CEM 기반 탐지 맵 사용
   - 타겟: 상위 0.15%, 배경: 하위 30%

2. **패치 설정 변경**
   - 패치 크기: 7 → **32**
   - 패치 중복: 없음 → **16**

3. **학습 설정 변경**
   - 에포크: 50 → **10**
   - 배치 사이즈: 32 → **2**
   - 학습률: 1e-4 → **6e-5**

4. **손실 함수 변경**
   - BCEWithLogitsLoss → **CrossEntropyLoss (ignore_index=255)**

5. **옵티마이저 설정 변경**
   - Weight Decay: 0.01 → **5e-4**
   - **Layer Decay 적용** (rate=0.9)

6. **정규화 변경**
   - Min-Max → **StandardScaler**

**Target Detection 태스크는 전면 재구현이 필요함**
